# 🏥 醫療帳務資料合併工具 (精準座標版)

這是一款專為醫療機構設計的自動化帳務核對工具，旨在將每日繁瑣的 Excel 資料 (day.xlsx) 精準合併至年度明細總表 (115年度明細表)，並嚴格遵循 Excel 座標邏輯，確保對帳金額 100% 準確。

## 🌟 核心功能

- **座標級精準填入**：完全遵循 VBA 索引邏輯，直接對應 Excel 欄位編號，不依賴標題文字。
- **生產實收自動拆分**：
  - 當「預收款 >= 0」時，自動加總「麻醉費 + 產費 + 預收款」，並依醫師拆分至第 76 欄 (BX) 起。
  - 當「預收款 < 0」時，自動執行「HP結算」邏輯，填入第 224 欄。
- **Python 預加總技術**：在寫入前先於記憶體完成歸戶加總，採用「覆蓋寫入」模式，徹底杜絕重複計入或金額翻倍的問題。
- **即時對帳報表**：合併完成後，網頁會保留詳細的座標對帳表（預設優先依 Excel 欄位排序），並保留供比對用。
- **獨立原始數據查帳面板**：額外提供四個獨立分頁（工作表1門診、工作表2出院與生產、工作表3嬰兒室、工作表4&5欠還款），顯示計算過程與原始數值（例如 `小計 - 掛號 - 負擔`），幫助快速肉眼抓蟲與核對。
- **隱私安全**：內建 `.gitignore` 保護，確保所有測試用的 XLSX 資料與暫存腳本不會被上傳至雲端。

## 🛠️ 使用說明

1. **環境準備**：安裝必要的 Python 套件。
   ```bash
   pip install -r requirements.txt
   ```
2. **啟動工具**：
   ```bash
   streamlit run app.py
   ```
3. **操作流程**：
   - 同時拖入「115年度明細表」與「每日來源資料 (day.xlsx)」。
   - 點擊「🚀 開始精準合併並對帳」。
   - 檢查網頁下方的「獨立對帳面板」核對原始數據及算式，並以「詳細對帳單」確認最終寫入座標無誤。
   - 點擊「💾 下載結果檔案」。

## 📌 資料處理規則明細 (精簡版)

- **門診 (OPD)**：實收 = 小計 - 掛號 - 部分負擔。一般醫師區分早、午、晚診；兒科、外賣(DT)、哺乳諮詢(BO)、營養諮詢(BP)、自然產諮詢(BQ) 採不分診次獨立加總。
- **出院 (IPD)**：自動對應病房費 (85+)、材料費 (95+)、伙食費 (105+)。
- **嬰兒室**：依醫師代號直接累計小計金額至第 115 欄 (DK) 起。
- **欠款/還款**：不分醫師，依日期自動彙整至 EE (135) 與 DS (123) 欄位。

---
*本工具僅供內部對帳使用，請確保主模板之格式定義符合最新規則。*
